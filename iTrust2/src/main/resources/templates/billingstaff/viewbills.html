<html xmlns:th="http://www.thymeleaf.org">

<head th:include="layout :: head(title=~{::title},links=~{::script})">
<title>View Office Visits</title>
	<script th:src="@{/js/dateTimeService.js}"
			src="../../../js/dateTimeService.js"></script>
	<script th:src="@{/js/jk-rating-stars.js}"
			src="../../../js/jk-rating-stars.js"></script>

</head>

<body th:include="layout :: body" th:with="content=~{::content}">
	<div th:fragment="content">


		<script th:inline="javascript">
      /* Otherwise Thymeleaf tries to parse Javascript as XML and breaks itself sometimes.  Sigh */
      /*<![CDATA[*/
      var app = angular.module("viewOfficeVisitsApp", ['dateTimeServices', 'jkAngularRatingStars']);

	  /**
	   * A filter to humanize the text to be more user friendly.
	   */
	  app.filter('humanize', function() {
		  return function (input) {

			  if (input == null || input == "") {
			  	return "";
			  }

			  return input.toLowerCase().split('_')
					  .map((word) => word.charAt(0).toUpperCase() + word.substring(1))
					  .join(' ');
		  }
	  });

      app.controller('viewOfficeVisitsCtrl', function ($scope, $http, dateTimeService) {
        $scope.visits = [];
        $http.get("/iTrust2/api/v1/officevisits").then(
                function (response) {
                  $scope.visits = response.data;
                  $scope.errorMsg = "";
                }, function (rejection) {
                  $scope.visits = [];
                  $scope.errorMsg = "Could not display office visits.";
                });
        $scope.loadTable = function () {
        
          $http.get("/iTrust2/api/v1/patients").then(
                  function (response) {
                    $scope.patients = response.data;
                    $scope.errorMsg = "";
                  }, function (rejection) {
                    $scope.visits = [];
                    $scope.errorMsg = "Could not display patients.";
                  });
        }
        $scope.loadTable();

        $scope.visit = null;
        $scope.selectPatient = function (p) {
        	
        	$scope.patient = p;
            // Stop displaying previous panels
            $scope.display = false;
            $scope.displaySurvey = false;
        	
            $scope.visit = true;

			const age = dateTimeService.getAge(new Date(visit.patient.dateOfBirth), new Date(visit.date));
			if (age < 3) {
				$scope.three = true;
			}
			if (age >= 3) {
				$scope.threeAndUp = true;
			}
			if (age >= 12) {
				$scope.twelveAndUp = true;
			}

		}

        // View the visit that was selected in the table
		  $scope.viewSelectedVisit = function() {
			  // Get the selected visit from the api.
			  // The id of the selected visit is $scope.selectedOfficeVisit
			  // Once you get the details of the visit, store it in $scope.visit
			  $scope.display = true;
			  $scope.displaySurvey = false;
		  }


		

	  });
			/*]]>*/
    </script>

		<div ng-app="viewOfficeVisitsApp" ng-controller="viewOfficeVisitsCtrl">
			<div class="container">
				<div class="row">
					<div class="col-md-12">
						<div class="panel panel-primary">
							<div class="panel-heading">
								<h3>View and Pay Bill</h3>
							</div>
							<div class="panel-body">
								<table class="table table-bordered">
									<caption>Patients:</caption>
									
									<thead>
										<tr>
											<th> </th>
											<th>First</th>
											<th>Last</th>
											<th>Location</th>
										</tr>
									</thead>
									<tbody>
										<tr name="officeVisitsTableRow"
											ng-repeat="p in patients "
											visitId={{v.id}}>
											<td name="selectCell"><input type="radio" name="selectRow" ng-model="$parent.selectedOfficeVisit" ng-value="v.id" ng-click="selectPatient(p)"></td>
											<td name="dateCell">{{p.firstName}}</td>
											<td name="providerCell">{{p.lastName}}</td>
						
										</tr>
									</tbody>
								</table>
								
								<!-- Error Messages -->
								<div class="row">

									<div class="col-md-12 text-right">
										<div style="white-space: pre-line;">
											<div name="errorMsg" class="text-danger">{{errorMsg}}</div>
										</div>
									</div>
								</div>
								
							</div>
							
							<div class="panel-footer text-right">
								<!-- button may have to be inside form tag, or just a submit function for the form? -->
								<button class="btn btn-lg" ng-click="showSurvey()"
									name="showSurvey" ng-disabled="!visit" ng-show="visit && !visit.satisfactionSurvey">Fill Survey</button>
								<button class="btn btn-lg" ng-click="showSurvey()"
									name="showSurvey" ng-show="visit && visit.satisfactionSurvey">View Survey</button>
								<button class="btn btn-primary btn-lg" ng-click="viewSelectedVisit()"
									name="viewVisit" ng-disabled="!visit">View Details</button>
							</div>
							
						</div>
						
						
						<!-- Display the information about the selected visit -->
						<div class='panel panel-default' ng-if="visit && (display || displaySurvey)">

							<!-- Show correct heading based on what button was pressed -->
							<div class="panel-heading" ng-show="display">
								<h3>Selected Visit Details</h3>
							</div>
							
							<div class="panel-heading" ng-show="displaySurvey">
								<h3>Satisfaction Survey</h3>
							</div>
							
							<div class='panel-body'>
	
								<div ng-if="display" class="row">
	
										<div class="panel panel-info">
											<div class="panel-heading">
												<h4>Office Visits</h4>
											</div>
											<div class="panel-body">
												<div class="form-group row" ng-repeat="v in visits" >
													<div class="col-xs-12 radio-box">
														<div class="form-check">
														<input type="radio" name = "visitradio" ng-model = "v">
															<ul>
																<li> {{v.hospital.name}} | Visit date: {{v.date}} | Total cost of visits: ${{v.total}} </li>
															</ul>
														</div>
													</div>
												</div>
											</div>
										</div>
									</div>
		
									
					
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</body>

</html>